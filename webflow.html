<!-- Chat notification styles -->
<style>
  @keyframes pulse {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 0 0 6px rgba(255, 59, 48, 0);
    }
    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(255, 59, 48, 0);
    }
  }

  @keyframes slideIn {
    0% {
      opacity: 0;
      transform: translateY(10px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<!-- Notification Message Bubble -->
<div id="notification-message"
     style="display: none; position: fixed; bottom: 100px; right: 24px; background-color: white; color: #333; padding: 14px 18px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 2147483646; max-width: 240px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 15px; animation: slideIn 0.4s ease-out; font-weight: 500;">
  How can I help? ðŸ‘‹
  <!-- Message tail/pointer -->
  <div style="position: absolute; bottom: -6px; right: 20px; width: 14px; height: 14px; background-color: white; transform: rotate(45deg);"></div>
</div>

<!-- Chat Bubble -->
<div id="chat-bubble"
     style="position: fixed; bottom: 24px; right: 24px; width: 64px; height: 64px; cursor: pointer; z-index: 2147483647; transition: transform 0.3s;">
  <div style="width: 100%; height: 100%; border-radius: 50%; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
    <!-- Avatar loaded from Vercel deployment -->
    <img src="https://openai-chatkit-starter-app-beta.vercel.app/avatar.png" alt="Chat" style="width: 100%; height: 100%; object-fit: cover;">
  </div>
  <!-- Notification Badge (small dot indicator) -->
  <div id="notification-badge"
       style="display: none; position: absolute; top: -2px; right: -2px; background-color: #FF3B30; border-radius: 50%; width: 16px; height: 16px; border: 2px solid white; animation: pulse 2s infinite;">
  </div>
</div>

<!-- Chat iframe (hidden by default) -->
<iframe id="chat-iframe"
        src="https://openai-chatkit-starter-app-beta.vercel.app/"
        style="display: none; position: fixed; bottom: 100px; right: 24px; width: 400px; height: 600px; border: none; border-radius: 16px; box-shadow: 0 0 24px rgba(0,0,0,0.2); z-index: 2147483646;">
</iframe>

<script type="text/javascript">
  (function() {
    const NOTIFICATION_DELAY_MS = 100;
    const AUDIO_URL = "https://efoawoucannrubkjicli.supabase.co/storage/v1/object/public/calls/new-notification-3-398649.mp3";

    // Elements
    const bubble = document.getElementById('chat-bubble');
    const frame = document.getElementById('chat-iframe');
    const badge = document.getElementById('notification-badge');
    const message = document.getElementById('notification-message');

    // State
    let open = false;
    let notificationFired = false;
    let gestureSeen = false;

    // Audio setup
    const audio = new Audio(AUDIO_URL);
    audio.preload = 'auto';

    // Handle user gesture
    function onGesture() {
      if (gestureSeen) return;
      gestureSeen = true;
      maybeShowNotification();
      ["pointerdown", "click", "touchstart", "keydown"].forEach(evt =>
        document.removeEventListener(evt, onGesture, { passive: true })
      );
    }

    ["pointerdown", "click", "touchstart", "keydown"].forEach(evt =>
      document.addEventListener(evt, onGesture, { passive: true })
    );

    // Play notification sound
    function playChime() {
      audio.play().catch(() => {});
    }

    // Show notification after user interaction
    function maybeShowNotification() {
      if (notificationFired || !gestureSeen) return;
      notificationFired = true;
      setTimeout(() => {
        message.style.display = 'block';
        badge.style.display = 'block';
        playChime();
      }, NOTIFICATION_DELAY_MS);
    }

    // Hide notification
    function hideNotification() {
      message.style.display = 'none';
      badge.style.display = 'none';
    }

    // Toggle chat
    bubble.addEventListener('click', () => {
      open = !open;
      frame.style.display = open ? 'block' : 'none';
      if (open) hideNotification();
    });

    // Listen for close message from iframe
    window.addEventListener('message', (event) => {
      if (event.data && event.data.type === 'CLOSE_CHAT') {
        open = false;
        frame.style.display = 'none';
      }
    });
  })();
</script>
